#include "Laser_USART.h"

// ??????????????(??????)
uint8_t USART_LASER_RX_BUF[USART_LASER_RX_BUF_LEN] = {0};

// ???????????
uint8_t new_package[USART_LASER_RX_BUF_LEN];
//??????????????????(0?????????? , 1???????????????)
uint8_t g_new_package_flag = 0;			

// ????????(???????????????)
uint16_t Laser_Loc[10] ;		// ????????????0 tx ty lx ly
uint16_t  Rect_Loc[10]  ;		// ????????????//0: x0, 1: y0£¬ 2£ºx1, 3: y1, 4: x2, 5: y2, 6: x3, 7: y3

// ??????????
int Laser_error = -1 ;	// -1:?????	// 0 : ????	// 1 : ????????	// 2 : ???	//  3 : ???
int Rect_error	= -1 ;

// ???????????????????????,??????????????0,????????error????1??????
int Laser_Find_None_Init = 1 ;
int  Rect_Find_None_Init = 1 ; 

// ??????????
void Laser_USART_Init(void)
{
		//?????????????
    NVIC_ClearPendingIRQ(LASER_INI_IRQn);
    //??????????
    NVIC_EnableIRQ(LASER_INI_IRQn);
}

//?????????????
void Laser_send_char(char ch)
{
    //??????0?????????????????????????????????
    while( DL_UART_isBusy(LASER_UART) == true );
    //??????????
    DL_UART_Main_transmitData(LASER_UART, ch);
}
//????????????
void Laser_send_string(char* str)
{
    //?????????????????? ???? ??????????????
    while(*str!=0&&str!=0)
    {
        //?????????????????????????????????????????????
        Laser_send_char(*str++);
    }
}
// ???????
// ??????????
uint8_t Get_High_Val_Of_Hex( uint16_t value )
{
	return (value >> 8) & 0xFF;
}
// ??????????
uint8_t Get_Low_Val_Of_Hex( uint16_t value )
{
	return value & 0xFF;
}
// ????+????????????????
uint16_t Get_Val_Of_Hex( uint8_t high , uint8_t low )
{
	return ((uint16_t)high << 8) | low;
}
void Deal_Rx(uint8_t rxtemp)
{
	// ???????????????
	static uint8_t g_start = 0;
	// ??????????????
  static uint8_t Sensor_Rx_Count = 0;
	// ?????????
  if(rxtemp == 0x12)
  {  
    g_start = 1;//?????????
    USART_LASER_RX_BUF[Sensor_Rx_Count ++] = rxtemp;	// ?????????
  }
  else
  {
		// ??????????????????????????
    if(g_start == 0)
    {
			// *???????*
			Laser_error = 3 ;
			Rect_error  = 3 ;
      return;
    }
    else	// ???????
    {
      USART_LASER_RX_BUF[Sensor_Rx_Count ++] = rxtemp;
      if(rxtemp == 0x5B)//????
      {
				// ????????
        g_start = 0;
        Sensor_Rx_Count = 0;
				// ???????????????????????,???????????
        memcpy(new_package,USART_LASER_RX_BUF,USART_LASER_RX_BUF_LEN);
				// ????????????
        g_new_package_flag = 1;
				//???????
        memset(USART_LASER_RX_BUF,0,USART_LASER_RX_BUF_LEN);
				// *????????*
				Laser_error = 0 ;
				Rect_error  = 0 ;
      }
      if(Sensor_Rx_Count >= USART_LASER_RX_BUF_LEN)//??????
      {
				// *???????*
				Laser_error = 3 ;
				Rect_error  = 3 ;
        g_start = 0;
        Sensor_Rx_Count = 0;
        memset(USART_LASER_RX_BUF,0,USART_LASER_RX_BUF_LEN);//???????
      }
    }
  }
}
// ???CANMV??????????????
void Get_CanMV_Loc(int Begin_Index_Of_Buf , int Data_Num , uint16_t Loc[] )
{
	for (int i = 0 ; i < Data_Num ; i += 2)
	{
		Loc[i / 2] = Get_Val_Of_Hex( new_package[i + Begin_Index_Of_Buf], new_package[i + Begin_Index_Of_Buf + 1] );
	}
}

void Get_Laser_Loc( uint16_t Loc[] )
{
	Get_CanMV_Loc(Laser_Begin , Laser_RX_Num , Loc ) ;
}

void Get_Rect_Loc( uint16_t Loc[] )
{
	Get_CanMV_Loc(Rect_Begin , Rect_RX_Num , Loc ) ;
}

// ?????????????
bool Array_Empty(uint16_t arr[], int len)
{
    for (int i = 0; i < len; i++)
    {
        if ( arr[i] != 0 )
            return false;
    }
    return true;
}

// ????????
void Update_Error(uint16_t arr[] ,int len , int *error , int *Loc_Find_None_Init)
{
	// ???????,
	if (*error != 3)
	{
		// ???????????,????????????
		if ( Array_Empty(arr , len) == true )
		{
			// ????????????Laser_Find_None_Init = 1,???????????????? , ??????????????,?????
			if ( *Loc_Find_None_Init == 0 )
				*error = 2 ; // ???
			else
				*error = 1 ; // ????????
		}
		else
		{
			// ??????
			*error = 0 ;
			*Loc_Find_None_Init = 0 ;
		}
	}
}

// ??????????,???
void CanMV_Mode(void)
{
	// ?????????????
	char uart_data = DL_UART_Main_receiveData(LASER_UART) ;
	Deal_Rx(uart_data) ;
	// ???????????????????
	if (g_new_package_flag == 1)
	{
		g_new_package_flag = 0 ;
		Get_Laser_Loc(Laser_Loc) ;
		Get_Rect_Loc(Rect_Loc)  ; 
	}
	// ????????????
	Update_Error(Laser_Loc , Laser_RX_Num / 2 , &Laser_error , &Laser_Find_None_Init) ;
	Update_Error(Rect_Loc  ,  Rect_RX_Num / 2 ,  &Rect_error , &Rect_Find_None_Init ) ;
}
